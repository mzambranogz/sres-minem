MRVMM."PKG_MRV_ADMIN_SISTEMA"

--HEAD--
  PROCEDURE USP_SEL_OBTIENE_USUARIO_CORREO(
    PI_CORREO VARCHAR2,
    PO_REF OUT SYS_REFCURSOR
  );

  PROCEDURE USP_SEL_OBTIENE_INSTITUCION_RUC(
    PI_RUC VARCHAR2,
    PO_REF OUT SYS_REFCURSOR
  );

  PROCEDURE USP_SEL_OBTIENE_INSTITUCION(
    PI_ID_INSTITUCION NUMBER,
    PO_REF OUT SYS_REFCURSOR
  );

  PROCEDURE USP_SEL_REDUCIDOS_MEDIDA(
        PI_RUC IN VARCHAR2,
        PI_ID_INICIATIVAS IN VARCHAR2,
        PO_REF OUT SYS_REFCURSOR
  );

--BODY----
  PROCEDURE USP_SEL_OBTIENE_USUARIO_CORREO(
    PI_CORREO VARCHAR2,
    PO_REF OUT SYS_REFCURSOR
  ) AS
  BEGIN
    OPEN PO_REF FOR
    SELECT
    U.ID_USUARIO,
    U.NOMBRES_USUARIO,
    U.APELLIDOS_USUARIO,
    U.EMAIL_USUARIO,
    U.TELEFONO_USUARIO,
    U.ANEXO_USUARIO,
    U.CELULAR_USUARIO,
    U.PASSWORD_USUARIO,
    U.ID_INSTITUCION
    FROM T_GENM_USUARIO U
    WHERE U.EMAIL_USUARIO = PI_CORREO;
  END USP_SEL_OBTIENE_USUARIO_CORREO;

  PROCEDURE USP_SEL_OBTIENE_INSTITUCION_RUC(
    PI_RUC VARCHAR2,
    PO_REF OUT SYS_REFCURSOR
  ) AS
  BEGIN
    OPEN PO_REF FOR
    SELECT
    I.ID_INSTITUCION,
    I.RUC_INSTITUCION,
    I.NOMBRE_INSTITUCION,
    I.DIRECCION_INSTITUCION,
    I.ID_SECTOR_INSTITUCION,
    I.FLAG_ESTADO
    FROM T_GENM_INSTITUCION I
    WHERE I.RUC_INSTITUCION = PI_RUC;
  END USP_SEL_OBTIENE_INSTITUCION_RUC;
  
  PROCEDURE USP_SEL_OBTIENE_INSTITUCION(
    PI_ID_INSTITUCION NUMBER,
    PO_REF OUT SYS_REFCURSOR
  ) AS
  BEGIN
    OPEN PO_REF FOR
    SELECT
    I.ID_INSTITUCION,
    I.RUC_INSTITUCION,
    I.NOMBRE_INSTITUCION,
    I.DIRECCION_INSTITUCION,
    I.ID_SECTOR_INSTITUCION,
    I.FLAG_ESTADO
    FROM T_GENM_INSTITUCION I
    WHERE I.ID_INSTITUCION = PI_ID_INSTITUCION;
  END USP_SEL_OBTIENE_INSTITUCION;

  PROCEDURE USP_SEL_REDUCIDOS_MEDIDA(
        PI_RUC IN VARCHAR2,
        PI_ID_INICIATIVAS IN VARCHAR2,
        PO_REF OUT SYS_REFCURSOR
    )AS
        vSQL  VARCHAR2(4000);
    BEGIN
        vSQL := '
        SELECT  DISTINCT
        ACU.ID_INICIATIVA, INI.DESC_INICIATIVA, SUM(ACU.REDUCIDO) REDUCIDO, ACU.ID_MEDMIT, MD.NOMBRE_MEDMIT
        FROM  T_GENM_INICIATIVA INI
        INNER JOIN  T_GENM_ACUMULADO ACU ON INI.ID_INICIATIVA = ACU.ID_INICIATIVA
        INNER JOIN  T_MAE_MEDMIT MD ON ACU.ID_MEDMIT = MD.ID_MEDMIT
        INNER JOIN  T_GENM_USUARIO USU ON INI.ID_USUARIO = INI.ID_USUARIO
        INNER JOIN  T_GENM_INSTITUCION INS ON USU.ID_INSTITUCION = INS.ID_INSTITUCION
        WHERE INS.RUC_INSTITUCION = '''|| PI_RUC ||''' AND INI.ID_INICIATIVA NOT IN ('|| PI_ID_INICIATIVAS ||') AND INI.ID_TIPO_INICIATIVA = 6
        GROUP BY ACU.ID_INICIATIVA, ACU.ID_MEDMIT, MD.NOMBRE_MEDMIT, INI.DESC_INICIATIVA
        ORDER BY  ACU.ID_INICIATIVA ASC';
        OPEN PO_REF FOR vSQL;
    END USP_SEL_REDUCIDOS_MEDIDA;